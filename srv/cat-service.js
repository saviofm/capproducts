const cds = require('@sap/cds');
const validation = require('./common/validation')
const crud = require('./common/crud')
const xsenv = require("@sap/xsenv");
const AWS = require('aws-sdk');


class CatalogService extends cds.ApplicationService {
    init() {
        
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // INIT - Instanciando S3                                                           //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//

        xsenv.loadEnv();
        const objectstore = xsenv.readServices()['capproducts-objectstore-service'];
        const bucket = objectstore.credentials.bucket;
        const credentials = new AWS.Credentials(
            objectstore.credentials.access_key_id,
            objectstore.credentials.secret_access_key
        );
        AWS.config.update({
            region: objectstore.credentials.region,
            credentials: credentials

        })
        const s3 = new AWS.S3({
            apiVersion: '2006-03-01'
        })


        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // PRODUCTS - Create - Valida se o EAN já existe                                    //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.before('CREATE', ['Products', 'ProductsFiori'], async (req) => {
            return await validation.ProductCreate(req);
        });
  
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // PRODUCTS - Create - Obtém o Content e faz a criação                              //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('CREATE', ['Products','ProductsFiori'], async (req, next) => {
            if (req.data.imageContent) {
                return await crud.ProductCreate(req, s3, bucket)
            } else {
                return next();
            }
        }); 
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // PRODUCTS - READ -  Obtém o stream                         //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('READ', ['Products','ProductsFiori'], (req, next) => {
            if (req.data.ID && req.query._streaming) {            
                const params = {
                    Bucket: objectstore.credentials.bucket,
                    Key: req.data.ID
                };
                
                return {   
                    value: _getObjectStream(req.data.ID)
                }
            } else {
                return next()
            }
        });
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // PRODUCTS - READ - Obtém o url                            //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.after('READ', ['Products','ProductsFiori'], (each, req) => {
            if (!req.query._streaming) {
                crud.ProductRead(each, s3, bucket);
            }
        });
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // Products - UPDATE - Verifica se o EAN existe e é diferente do produto atual      //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.before('UPDATE', ['Products', 'ProductsFiori'], async (req) => {  
            return await validation.ProductUpdate(req);  
        });

        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // Products - UPDATE - Verifica conteúdo                                            //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('UPDATE', ['Products','ProductsFiori'], async (req, next) => {
            if (req.data.imageContent) {
                return await crud.ProductCreate(req, s3, bucket)
            } else {
                return next();
            }
        });

        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // Products - DELETE - Elimina conteúdo                                            //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.before('DELETE', ['Products','ProductsFiori'], async (req) => {
           
            await validation.ProductDelete(req);

            return await crud.ProductDelete(req, s3, bucket);
            
        });

        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // MEDIA - Create - Obtém o Content e faz a criação                                 //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('CREATE', 'ProductMedia', async (req, next) => {
            if (req.data.mediaContent) {
                const tx = cds.transaction(req);
                const contentType = req._.req.headers['content-type']
                const params = {
                    Bucket: objectstore.credentials.bucket,
                    Key: req.data.ID,
                    Body: req.data.content,
                    ContentType: contentType
                };
                req.data.mediaContent = null;
           

                const data = await s3.upload(params).promise();
                
                return tx.update(cds.entities.Medias)
                    .set({
                        mediaType: contentType
                    })
                    .where({
                        ID: req.data.ID
                    });
                
            
            } else {
                return next();
            }
        });

        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // MEDIA - Create - Obtém o Content e faz a atualização                             //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('UPDATE', 'ProductMedia', async (req, next) => {
            if (req.data.mediaContent) {
                const tx = cds.transaction(req);
                const contentType = req._.req.headers['content-type']
                const params = {
                    Bucket: objectstore.credentials.bucket,
                    Key: req.data.ID,
                    Body: req.data.content,
                    ContentType: contentType
                };
                req.data.mediaContent = null;
              
                const data = await s3.upload(params).promise();
                
                return tx.update(cds.entities.Medias)
                    .set({
                        mediaType: contentType
                    })
                    .where({
                        ID: req.data.ID
                    });
                
            
            } else {
                return next();
            }
        });
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // MEDIA - Read -  Obtém o Content como stream e o url                        //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.on('READ', 'ProductMedia', (req, next) => {
            if (!req.data.ID) {
                return next()
            }
            
            const params = {
                Bucket: objectstore.credentials.bucket,
                Key: req.data.ID
            };
            
            //return s3.getSignedUrl('getObject', params); 
            
            return {   
                value: _getObjectStream(req.data.ID)
            }
            
        });
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        // MEDIA - Read -  Obtém o Content como stream e o url                              //
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        //----------------------------------------------------------------------------------//
        this.after('READ', 'ProductMedia',  each => {
            
            
            const params = {
                Bucket: objectstore.credentials.bucket,
                Key: each.ID
            };
            
            each.mediaUrl = s3.getSignedUrl('getObject', params)

        });   

        //----------------------------------------------------------------------------------//
        //_getObjectStream                                                                  //
        //----------------------------------------------------------------------------------//        
        /* Get object stream from S3 */
        function _getObjectStream(objectKey) {
            const params = {
                Bucket: objectstore.credentials.bucket,
                Key: objectKey
            };
            return s3.getObject(params).createReadStream()
 
        };


        return super.init();
    }
}

module.exports = { CatalogService };
